import { Stats } from "fast-stats";
import request from "request";
import { sendLatencyTestResult } from "./loadtest/slack.mjs";
import { purgeCache, warmCache } from "./loadtest/util.mjs";
const MAX_REQUESTS = 300;

const url =
  process.env.URL ??
  "https://next-prisma-polyscale-eu.herokuapp.com/properties/ca5617be-d5fd-489d-b962-edf2d8feea80";

const sleep = (ms) =>
  new Promise((resolve) => {
    setTimeout(() => {
      resolve();
    }, ms);
  });

const call = async () => {
  return new Promise((resolve) => {
    request.get(url, { time: true }, (err, response) => {
      resolve(response.elapsedTime);
    });
  });
};

async function* gen() {
  for (let i = 0; i < MAX_REQUESTS; i++) {
    const execTime = await call();

    yield execTime;
  }
}

const main = async () => {
  await purgeCache();

  console.log("Warming cache...");

  await warmCache();

  const t = new Stats();
  for await (const execTime of gen()) {
    t.push(execTime);
  }

  await sendLatencyTestResult({
    result: {
      amean: t.amean(),
      median: t.median(),
    },
  });

  console.log("Median: ", t.median());
  console.log("P50: ", t.percentile(50));
  console.log("P90: ", t.percentile(90));
  console.log("P95: ", t.percentile(95));
  console.log("P99: ", t.percentile(99));
  console.log(JSON.stringify(t.data));
};

main();

/** 
Direct
US
Median:  792.5
P50:  792.5
P90:  1005
P95:  1041
P99:  1759
[1549,1100,671,773,733,909,907,823,664,697,855,655,721,803,746,711,796,1005,1041,814,819,660,707,775,711,690,696,715,770,670,696,703,669,695,939,630,908,670,720,764,690,741,682,736,1130,703,664,693,1826,823,824,679,740,679,694,722,709,770,694,690,769,626,801,944,980,669,655,670,784,707,718,820,633,909,817,676,690,775,691,904,1042,691,754,642,700,662,675,691,1013,692,912,765,685,741,698,19883,830,801,1014,820,830,808,815,926,682,844,821,815,731,730,904,905,683,665,832,786,817,816,770,699,661,735,917,692,1036,1037,822,900,709,840,686,815,842,642,648,860,749,726,774,818,672,846,781,759,821,1010,828,660,970,608,703,838,697,952,806,672,673,699,824,699,1041,817,913,824,808,1027,670,689,689,797,766,985,927,812,885,753,818,652,856,834,1033,1014,828,757,791,1003,1108,796,631,591,759,1128,816,1260,890,704,753,809,705,807,701,1136,918,819,822,816,779,751,754,879,926,1015,1126,819,754,778,818,832,802,801,679,961,830,925,678,855,679,635,829,822,750,893,787,765,891,721,681,641,914,660,715,686,673,650,811,710,1010,828,684,754,1005,712,1759,815,816,820,814,674,682,794,816,816,718,1023,814,817,945,679,835,886,692,876,644,784,687,847,815,818,814,1008,830,820,816,698,683,870,917,815,823,815,660,876,1010,671,779,1313,724,738,802,1105]
*/

/**
Direct
EU
Median:  614
P50:  614
P90:  717
P95:  745
P99:  831
[1987,699,547,786,544,612,612,612,620,608,615,614,577,565,693,619,586,549,587,552,676,622,671,656,604,616,616,607,618,638,684,612,614,606,696,547,598,615,551,566,513,563,857,565,577,683,641,684,546,541,678,618,607,579,732,702,684,570,580,722,813,649,615,607,621,607,528,591,616,617,606,615,613,550,678,613,546,582,580,644,611,617,554,566,608,622,552,578,609,630,697,611,615,572,644,683,822,648,613,614,606,584,561,661,650,729,598,717,552,673,555,572,616,607,715,721,604,716,657,580,706,720,603,542,695,600,611,677,654,617,609,560,547,704,640,712,617,683,811,649,713,719,610,718,712,619,617,604,609,573,658,614,610,611,610,614,723,605,611,621,613,612,608,590,562,694,623,704,613,615,646,587,604,679,649,718,610,614,614,610,624,620,594,619,571,652,617,611,617,746,573,716,703,831,604,633,602,616,745,635,659,613,612,577,646,611,532,701,611,614,723,672,645,551,809,682,742,716,593,608,716,613,567,553,607,780,653,585,576,678,611,533,593,618,613,773,551,621,590,737,617,605,551,548,648,605,610,607,622,591,630,758,569,618,592,633,604,684,563,546,590,585,610,617,789,650,604,600,572,663,592,628,563,665,607,617,571,657,620,717,609,607,720,609,678,649,815,621,614,605,587,644,611,612,612,689,554,593,615,614]
 */

/**
Cached
US
Median:  636
P50:  636
P90:  660
P95:  673
P99:  1057
[631,626,670,636,623,679,639,608,591,598,645,635,637,1057,779,1377,755,599,625,619,593,594,593,633,599,613,628,636,641,611,619,635,617,593,593,612,635,642,610,595,641,639,596,631,619,620,652,660,614,669,603,643,630,648,660,659,600,621,635,659,636,624,629,652,627,605,656,619,622,597,637,610,614,645,628,607,646,647,632,630,630,617,637,642,616,645,640,609,588,612,620,592,621,611,638,597,615,599,658,640,646,592,641,626,616,599,636,612,621,631,653,657,684,613,644,662,646,610,651,660,618,607,618,645,676,655,665,663,667,646,604,692,657,663,604,678,640,636,591,640,643,634,638,593,639,588,640,642,642,643,644,637,596,592,668,608,654,643,591,634,594,597,643,647,602,642,646,639,659,658,648,605,637,603,601,656,620,681,640,606,658,660,661,663,657,647,620,601,633,638,669,627,607,647,669,641,652,593,633,644,642,647,648,638,638,590,638,642,594,597,634,639,640,645,636,591,642,634,593,648,592,651,636,644,666,643,591,638,635,590,638,644,648,601,636,673,643,637,639,589,596,589,634,607,638,645,634,602,634,592,602,654,640,644,608,614,601,636,635,648,658,607,588,633,641,589,597,593,648,643,592,639,1079,614,643,637,637,637,642,649,638,640,632,634,649,594,632,643,636,634,649,633,767,655,713,654,813,641,636,632]
 */

/**
Cached
EU
Median:  707
P50:  707
P90:  750
P95:  803
P99:  1199
[662,649,719,722,605,722,715,614,711,724,667,654,727,722,703,718,647,678,733,800,718,732,698,658,746,760,699,720,713,717,705,728,817,605,705,733,702,676,668,700,832,709,624,696,717,721,712,712,619,728,686,744,716,698,719,715,716,731,653,660,714,592,750,717,613,717,707,646,688,707,717,1370,885,1199,635,632,620,696,702,724,605,635,813,715,713,689,734,614,634,697,602,742,706,711,685,871,697,591,748,719,695,722,661,798,797,727,711,702,727,703,725,765,652,607,725,718,589,661,607,699,637,644,777,684,716,735,911,707,774,688,705,706,707,611,716,711,731,639,801,693,728,703,633,711,698,738,704,705,718,720,701,734,644,1691,711,611,714,640,695,724,700,714,732,718,715,717,656,716,641,735,628,671,631,743,636,679,713,627,668,671,661,624,645,699,732,830,711,702,625,803,733,730,692,723,705,698,731,645,655,744,718,717,716,698,731,696,616,726,717,719,601,830,596,617,717,724,703,718,633,714,803,726,707,711,707,718,669,655,625,722,694,649,636,779,713,717,728,716,676,660,583,628,720,619,694,722,659,663,728,705,734,707,701,668,772,802,729,716,659,663,726,656,658,831,657,673,697,724,707,719,729,673,750,713,707,725,805,725,703,687,809,760,703,603,730,708,729,699,618,720,722,660,655,734,700,624,657,658,678,676]
 */
